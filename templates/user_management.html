<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - Webæ¼æ´æ‰«æç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .user-management {
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-box input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 250px;
        }

        .search-box button {
            padding: 8px 15px;
            background: #00bcd4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .user-table th, .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .user-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .user-table tr:hover {
            background-color: #f1faff;
        }

        .role-select {
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }

        .btn-action {
            padding: 5px 10px;
            margin-right: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-edit {
            background-color: #17a2b8;
            color: white;
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
        }

        .btn-upload {
            background-color: #28a745;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }

        .pagination button {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background: white;
            cursor: pointer;
        }

        .pagination button.active {
            background: #00bcd4;
            color: white;
            border-color: #00bcd4;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-admin {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .status-user {
            background-color: #d4edda;
            color: #155724;
        }

        .avatar-preview {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }

        .upload-form {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .avatar-container {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 40px;
        }

        .upload-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 3px;
            border-radius: 50%;
            cursor: pointer;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 15px;
            font-size: 14px;
            display: none; /* é»˜è®¤éšè— */
        }

        .avatar-container:hover .upload-overlay {
            display: block; /* æ‚¬åœæ—¶æ˜¾ç¤º */
        }

        #avatarFile {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- é¡¶éƒ¨æ¨ªæ¡ -->
        <header class="topbar">
            <div class="system-title">Webæ¼æ´æ‰«æç³»ç»Ÿ</div>
            <div class="user-box">
                <div class="avatar-container">
                    <img src="{{ url_for('static', filename='avatars/' + (avatar or 'avatar.png')) }}" alt="å¤´åƒ" class="avatar">
                    <div class="user-tooltip">
                        <p>ç”¨æˆ·å: {{ username }}</p>
                        <p>ç™»å½•æ¬¡æ•°: {{ login_count }}</p>
                        <p>æœ€è¿‘ç™»å½•: {{ last_login }}</p>
                        <p>æƒé™ç­‰çº§: {{ 'ç®¡ç†å‘˜' if role == 'admin' else 'æ™®é€šç”¨æˆ·' }}</p>
                    </div>
                </div>
                <span class="username">{{ username }}</span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </header>

        <div class="body-wrapper">
            <!-- å·¦ä¾§åŠŸèƒ½å¯¼èˆª -->
            <aside class="sidebar">
                <nav class="nav-menu">

                    <a href="{{ url_for('index') }}" class="nav-item">  é¦–é¡µ</a>
                    <a href="{{ url_for('asset.asset_page') }}" class="nav-item">ğŸ’¼ èµ„äº§æ”¶é›†</a>
                    <a href="#" class="nav-item">ğŸ” æ¼æ´æ‰«æ</a>
                    <a href="#" class="nav-item">ğŸ“„ æŠ¥å‘Šç”Ÿæˆ</a>
                    <a href="#" class="nav-item">ğŸ“Š æ•°æ®åˆ†æ</a>
                    <a href="{{ url_for('user.manage_users') }}" class="nav-item active">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
                </nav>
            </aside>

            <!-- å†…å®¹åŒºåŸŸ -->
            <main class="main-panel">
                <div class="user-management">
                    <div class="management-header">
                        <h2>ç”¨æˆ·ç®¡ç†</h2>
                        {% if role == 'admin' %}
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·å..." value="{{ search_term }}">
                            <button onclick="searchUsers()">æœç´¢</button>
                        </div>
                        {% endif %}
                    </div>

                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>ç”¨æˆ·å</th>
                                <th>å¤´åƒ</th>
                                <th>è§’è‰²</th>
                                <th>ç™»å½•æ¬¡æ•°</th>
                                <th>æœ€è¿‘ç™»å½•</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>
                                    <div class="avatar-container">
                                        <img src="{{ url_for('static', filename='avatars/' + (user.avatar or 'avatar.png')) }}"
                                             alt="å¤´åƒ"
                                             class="avatar-preview"
                                             id="avatarPreview_{{ user.id }}">
                                        <div class="upload-overlay" onclick="document.getElementById('avatarFile_{{ user.id }}').click()">+</div>
                                        <input type="file" id="avatarFile_{{ user.id }}"
                                               accept="image/*"
                                               style="display: none;"
                                               onchange="uploadAvatar({{ user.id }}, this)">
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ user.role }}">
                                        {{ 'ç®¡ç†å‘˜' if user.role == 'admin' else 'æ™®é€šç”¨æˆ·' }}
                                    </span>
                                </td>
                                <td>{{ user.login_count }}</td>
                                <td>{{ user.last_login or 'ä»æœªç™»å½•' }}</td>
                                <td>
                                    {% if role == 'admin' or user.id == current_user_id %}
                                    <select class="role-select" id="role_{{ user.id }}"
                                            onchange="updateRole({{ user.id }})"
                                            {% if role != 'admin' %}disabled{% endif %}>
                                        <option value="admin" {% if user.role =='admin' %}selected{% endif %}>ç®¡ç†å‘˜</option>
                                        <option value="user" {% if user.role =='user' %}selected{% endif %}>æ™®é€šç”¨æˆ·</option>
                                    </select>
                                    <!-- æ·»åŠ æ¡ä»¶ï¼šç®¡ç†å‘˜ä¸”ä¸æ˜¯å½“å‰ç”¨æˆ·æ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’® -->
                                    {% if role == 'admin' and user.id != current_user_id %}
                                    <button class="btn-action btn-delete"
                                            onclick="deleteUser({{ user.id }}, '{{ user.username }}')">åˆ é™¤</button>
                                    {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" style="text-align: center;">æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- åˆ†é¡µæ§ä»¶ -->
                    {% if total_pages > 1 and role == 'admin' %}
                    <div class="pagination">
                        <button onclick="changePage(1)" {% if current_page == 1 %}disabled{% endif %}>é¦–é¡µ</button>
                        <button onclick="changePage({{ current_page - 1 }})" {% if current_page == 1 %}disabled{% endif %}>ä¸Šä¸€é¡µ</button>

                        {% for page_num in range(1, total_pages + 1) %}
                            {% if page_num == current_page %}
                                <button class="active">{{ page_num }}</button>
                            {% elif page_num >= current_page - 2 and page_num <= current_page + 2 %}
                                <button onclick="changePage({{ page_num }})">{{ page_num }}</button>
                            {% elif loop.index == 1 or loop.index == total_pages %}
                                <button onclick="changePage({{ page_num }})">{{ page_num }}</button>
                            {% elif page_num == current_page - 3 or page_num == current_page + 3 %}
                                <button disabled>...</button>
                            {% endif %}
                        {% endfor %}

                        <button onclick="changePage({{ current_page + 1 }})" {% if current_page == total_pages %}disabled{% endif %}>ä¸‹ä¸€é¡µ</button>
                        <button onclick="changePage({{ total_pages }})" {% if current_page == total_pages %}disabled{% endif %}>å°¾é¡µ</button>
                    </div>
                    {% endif %}

                    {% if role == 'admin' %}
                    <div class="pagination-info" style="text-align: center; margin-top: 10px; color: #6c757d;">
                        ç¬¬ {{ current_page }} é¡µ / å…± {{ total_pages }} é¡µ - æ€»è®¡ {{ total_users }} ä¸ªç”¨æˆ·
                    </div>
                    {% endif %}
                </div>
            </main>
        </div>
    </div>

    <script>
        function logout() {
            if (confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
                window.location.href = "{{ url_for('user.logout') }}";
            }
        }

        function updateRole(userId) {
            const newRole = document.getElementById(`role_${userId}`).value;

            fetch("{{ url_for('user.update_role', user_id=0) }}".replace('0', userId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `role=${newRole}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(`ç”¨æˆ·è§’è‰²å·²æ›´æ–°ä¸º${newRole === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}`);
                    location.reload();
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }

        function deleteUser(userId, username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            fetch("{{ url_for('user.delete_user', user_id=0) }}".replace('0', userId), {
                method: 'POST'
            })
            .then(response => {
                alert(`ç”¨æˆ· ${username} å·²è¢«åˆ é™¤`);
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`ç”¨æˆ· ${username} å·²è¢«åˆ é™¤`);
                location.reload();
            });
        }

        // åˆ†é¡µå‡½æ•°
        function changePage(page) {
            const searchTerm = document.getElementById('searchInput').value;
            let url = "{{ url_for('user.manage_users') }}?page=" + page;

            if (searchTerm) {
                url += "&search=" + encodeURIComponent(searchTerm);
            }

            window.location.href = url;
        }

        // æœç´¢å‡½æ•°
        function searchUsers() {
            const searchTerm = document.getElementById('searchInput').value;
            window.location.href = "{{ url_for('user.manage_users') }}?search=" + encodeURIComponent(searchTerm);
        }

        // æ”¯æŒå›è½¦é”®æœç´¢
        document.getElementById('searchInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                searchUsers();
            }
        });

        // å¤´åƒä¸Šä¼ åŠŸèƒ½
        function uploadAvatar(userId, input) {
            if (!input.files || !input.files[0]) return;

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const preview = document.getElementById(`avatarPreview_${userId}`);
            preview.style.opacity = '0.5';

            const file = input.files[0];
            const formData = new FormData();
            formData.append('avatar', file);

            fetch("{{ url_for('user.upload_avatar', user_id=0) }}".replace('0', userId), {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                preview.style.opacity = '1';
                if (data.status === 'success') {
                    // æ›´æ–°é¢„è§ˆå›¾ç‰‡
                    preview.src = data.avatar_url + '?' + new Date().getTime();

                    // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼Œæ›´æ–°é¡¶éƒ¨å¤´åƒ
                    if (userId === {{ current_user_id }}) {
                        document.querySelector('.topbar .avatar').src = data.avatar_url + '?' + new Date().getTime();
                    }
                } else {
                    alert('å¤´åƒä¸Šä¼ å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                preview.style.opacity = '1';
                console.error('Error:', error);
                alert('å¤´åƒä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
    </script>
</body>
</html>