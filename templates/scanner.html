<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Webæ¼æ´æ‰«æç³»ç»Ÿ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    body { background-color: #f4f6f8; font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif; }
    .scanner-panel { padding: 30px; margin: 30px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .scanner-panel h2 { font-size: 22px; margin-bottom: 20px; border-left: 5px solid #00bcd4; padding-left: 10px; }
    .form-section { margin-bottom: 20px; }
    input[type="file"], textarea {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;
      font-size: 14px; transition: border 0.3s ease; resize: vertical;
    }
    button {
      background-color: #00bcd4; color: white; padding: 10px 20px;
      font-size: 15px; border: none; border-radius: 8px; cursor: pointer;
    }
    .progress-bar {
      height: 20px; background-color: #e0e0e0; border-radius: 10px;
      overflow: hidden; margin-top: 10px;
    }
    .progress-bar-fill {
      height: 100%; background-color: #00bcd4; width: 0%; transition: width 0.5s ease;
    }
    .scan-results table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd; padding: 10px; text-align: left;
    }
    th { background-color: #f7f7f7; }
    .status-ok { color: green; }
    .status-alert { color: red; }
    .details-row { background-color: #fafafa; font-size: 13px; }
  </style>
</head>
<body>
<div class="dashboard-container">
  <header class="topbar">
    <div class="system-title">Webæ¼æ´æ‰«æç³»ç»Ÿ</div>
    <div class="user-box">
      <div class="avatar-container">
        <img src="{{ url_for('static', filename='avatars/' + (session.avatar or 'avatar.png')) }}" alt="å¤´åƒ" class="avatar">
        <div class="user-tooltip">
          <p>ç”¨æˆ·å: {{ session.username }}</p>
          <p>ç™»å½•æ¬¡æ•°: {{ login_count }}</p>
          <p>æœ€è¿‘ç™»å½•: {{ last_login }}</p>
          <p>æƒé™ç­‰çº§: {{ 'ç³»ç»Ÿç®¡ç†å‘˜' if session.role == 'admin' else 'æ™®é€šç”¨æˆ·' }}</p>
        </div>
      </div>
      <span class="username">{{ session.username }}</span>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <div class="body-wrapper">
    <aside class="sidebar">
      <nav class="nav-menu">
        <a href="{{ url_for('index') }}" class="nav-item">ğŸ  é¦–é¡µ</a>
        <a href="{{ url_for('asset.asset_page') }}" class="nav-item">ğŸ’¼ èµ„äº§æ”¶é›†</a>
        <a href="{{ url_for('scanner.scanner_home') }}" class="nav-item active">ğŸ” æ¼æ´æ‰«æ</a>            
        <a href="#" class="nav-item">ğŸ“Š æ•°æ®åˆ†æ</a>
        <a href="{{ url_for('user.manage_users') }}" class="nav-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
      </nav>
    </aside>

    <main class="main-panel">
      <div class="scanner-panel">
        <h2>ğŸ” æ¼æ´æ‰«æ</h2>
        <form id="scanForm" method="POST" enctype="multipart/form-data">
          <div class="form-section">
            <label>ä¸Šä¼  TXT / CSV æ–‡ä»¶</label>
            <input type="file" name="target_file" accept=".txt,.csv" id="fileInput" />
          </div>
          <div class="form-section">
            <label>è¾“å…¥ç›®æ ‡ï¼ˆæ”¯æŒåŸŸåæˆ– IP:ç«¯å£ï¼Œæ¢è¡Œåˆ†éš”ï¼‰</label>
            <textarea name="manual_targets" placeholder="å¦‚ï¼šexample.com:8080" id="manualTargets"></textarea>
          </div>
          <button type="submit">å¼€å§‹æ‰«æ</button>
          <button type="button" onclick="window.location.href='/scanner/'">ğŸ”„ æ–°ä»»åŠ¡ / åˆ·æ–°</button>
          <div class="progress-bar" id="progressBar" style="display:none">
            <div class="progress-bar-fill" id="progressFill"></div>
          </div>
          <p id="scanStatusText"></p>
        </form>

        {% if results %}
        <div class="scan-results">
          <h3>æ‰«æç»“æœï¼š</h3>
          {% if task_id %}<a href="{{ url_for('scanner.export_csv', task_id=task_id) }}">ğŸ“¥ å¯¼å‡ºCSV</a>{% endif %}
          <table>
            <thead>
              <tr><th>ç›®æ ‡</th><th>çœä»½</th><th>æ€»æ•°</th><th>ä½</th><th>ä¸­</th><th>é«˜</th><th>ä¸¥é‡</th></tr>
            </thead>
            <tbody>
              {% for r in results %}
              <tr>
                <td>{{ r.target }}</td>
                <td>{{ r.province }}</td>
                <td class="{{ 'status-alert' if r.vuln_count > 0 else 'status-ok' }}">{{ r.vuln_count }}</td>
                <td>{{ r.severities.low }}</td>
                <td>{{ r.severities.medium }}</td>
                <td>{{ r.severities.high }}</td>
                <td>{{ r.severities.critical }}</td>
              </tr>
              {% if r.details %}
              <tr class="details-row">
                <td colspan="7">
                  <strong>æ¼æ´è¯¦æƒ…ï¼š</strong>
                  <ul>
                    {% for d in r.details %}
                    <li><strong>{{ d.name }}</strong> - {{ d.severity }} - {{ d.location }}</li>
                    {% endfor %}
                  </ul>
                </td>
              </tr>
              {% endif %}
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endif %}
      </div>
    </main>
  </div>
</div>

<script>
function logout() {
  if (confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
    window.location.href = "{{ url_for('user.logout') }}";
  }
}

fileInput.addEventListener('change', function () {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function (e) {
    manualTargets.value = e.target.result.trim();
  };
  reader.readAsText(file);
});

scanForm.addEventListener('submit', async function (e) {
  e.preventDefault();
  scanStatusText.textContent = 'â³ æ­£åœ¨å¯åŠ¨æ‰«æ...';
  progressBar.style.display = 'block';

  const formData = new FormData(scanForm);
  const res = await fetch("{{ url_for('scanner.start_scan') }}", { method: 'POST', body: formData });
  const data = await res.json();
  const taskId = data.task_id;

  const poll = setInterval(async () => {
    const r = await fetch(`/scanner/progress/${taskId}`);
    const p = await r.json();
    progressFill.style.width = `${p.progress}%`;
    scanStatusText.textContent = `è¿›åº¦: ${p.progress}% - æ­£åœ¨æ‰«æç›®æ ‡ï¼š${p.current_target || 'æœªçŸ¥'}`;
    if (p.status === 'finished') {
      clearInterval(poll);
      scanStatusText.textContent = 'âœ… æ‰«æå®Œæˆï¼ŒåŠ è½½ç»“æœ...';
      setTimeout(() => {
        location.href = `/scanner/results/${taskId}`;
    }, 500); // å»¶è¿Ÿ 0.5 ç§’è·³è½¬
  }}, 1000);
});
</script>
</body>
</html>
