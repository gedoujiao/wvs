<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>èµ„äº§æ”¶é›† - Webæ¼æ´æ‰«æç³»ç»Ÿ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    body {
      background-color: #f4f6f8;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    .scanner-panel {
      padding: 30px;
      margin: 30px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .scanner-panel h2 {
      font-size: 22px;
      margin-bottom: 20px;
      border-left: 5px solid #00bcd4;
      padding-left: 10px;
    }
    .form-section {
      margin-bottom: 20px;
    }
    input[type="file"],
    textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 14px;
      transition: border 0.3s ease;
    }
    textarea {
      height: 150px;
      resize: vertical;
    }
    button {
      background-color: #00bcd4;
      color: white;
      padding: 10px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 10px;
    }
    .progress-bar {
      height: 22px;
      background-color: #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 15px;
      margin-bottom: 20px;
    }
    .progress-bar-inner {
      height: 100%;
      background-color: #00bcd4;
      width: 0%;
      transition: width 0.5s ease;
    }
    .result-box {
      background-color: #fafafa;
      border: 1px solid #eee;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .port-table table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .port-table th,
    .port-table td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    .port-table th {
      background-color: #f7f7f7;
    }
    .port-open {
      color: green;
      font-weight: bold;
    }
    .port-closed {
      color: gray;
    }
    .csv-table th,
    .csv-table td {
      padding: 8px;
      border: 1px solid #ccc;
    }
   
  </style>
</head>
<body>
<div class="dashboard-container">
  <header class="topbar">
    <div class="system-title">Webæ¼æ´æ‰«æç³»ç»Ÿ</div>
    <div class="user-box">
      <div class="avatar-container">
        <img src="{{ url_for('static', filename='avatars/' + (avatar or 'avatar.png')) }}" alt="å¤´åƒ" class="avatar">
        <div class="user-tooltip">
          <p>ç”¨æˆ·å: {{ username }}</p>
          <p>ç™»å½•æ¬¡æ•°: {{ login_count }}</p>
          <p>æœ€è¿‘ç™»å½•: {{ last_login }}</p>
          <p>æƒé™ç­‰çº§: {{ 'ç®¡ç†å‘˜' if role == 'admin' else 'æ™®é€šç”¨æˆ·' }}</p>
        </div>
      </div>
      <span class="username">{{ username }}</span>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <div class="body-wrapper">
    <aside class="sidebar">
      <nav class="nav-menu">
        <a href="{{ url_for('index') }}" class="nav-item">ğŸ  é¦–é¡µ</a>
        <a href="{{ url_for('asset.asset_page') }}" class="nav-item active">ğŸ’¼ èµ„äº§æ”¶é›†</a>
        <a href="{{ url_for('scanner.scanner_home') }}" class="nav-item">ğŸ” æ¼æ´æ‰«æ</a>
        <a href="{{ url_for('visualization.index') }}" class="nav-item">ğŸŒ å…¨çƒçƒ­åŠ›å›¾</a>
        <a href="{{ url_for('analysis.analyze') }}" class="nav-item">ğŸ“Š æ•°æ®åˆ†æ</a>
        <a href="{{ url_for('user.manage_users') }}" class="nav-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
      </nav>
    </aside>

    <main class="main-panel">
      <div class="scanner-panel">
      <h2>ğŸ§­ èµ„äº§æ”¶é›†</h2>

      <div class="form-section">
        <label>ä¸Šä¼ ç›®æ ‡æ–‡ä»¶ (TXT / CSV)</label>
        <input type="file" id="targetFileInput" accept=".txt,.csv" />
        <small style="color: #666;">ä¸Šä¼ åå°†è‡ªåŠ¨å¡«å……ä¸‹æ–¹</small>
      </div>

      <div class="form-section">
        <label>ä¸Šä¼ å­åŸŸåå­—å…¸ï¼ˆå¯é€‰ï¼Œè‡ªå®šä¹‰è¦†ç›–é»˜è®¤å­—å…¸ï¼‰</label>
        <input type="file" id="dictFileInput" accept=".txt" />
        <small style="color: #666;">é»˜è®¤å°†ä½¿ç”¨ç³»ç»Ÿå†…ç½®çš„ 100/500/1000 å­—å…¸</small>
      </div>

      <div class="form-section">
        <label>å­åŸŸåå­—å…¸çº§åˆ«ï¼ˆä»…åœ¨æœªä¸Šä¼ å­—å…¸æ—¶ç”Ÿæ•ˆï¼‰</label>
        <select id="subdomainLevel">
          <option value="100">é»˜è®¤ 100 ä¸ª</option>
          <option value="500">å¢å¼º 500 ä¸ª</option>
          <option value="1000">æ·±åº¦ 1000 ä¸ª</option>
        </select>
      </div>

      <div class="form-section">
        <label>è¾“å…¥ç›®æ ‡ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
        <textarea id="targetInput" placeholder="example.com, 8.8.8.8 æˆ–æ¯è¡Œä¸€ä¸ªç›®æ ‡"></textarea>
      </div>

      <div class="form-section">
        <button onclick="startCollection()">å¼€å§‹èµ„äº§æ”¶é›†</button>
      </div>

      <div class="progress-bar">
        <div class="progress-bar-inner" id="progressInner"></div>
      </div>

      <div id="result" class="result-section"></div>
      <div id="csvTableContainer" class="result-section"></div>
      <div style="margin-top: 10px;">
        <button onclick="downloadCSV(false)">ä¸‹è½½å®Œæ•´ CSV</button>
        <button onclick="downloadCSV(true)">ä»…ä¸‹è½½ IP åˆ—</button>
      </div>
    </div>

    </main>
  </div>
</div>

<script>
function logout() {
  if (confirm("ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ")) {
    window.location.href = "{{ url_for('user.logout') }}";
  }
}
document.getElementById('targetFileInput').addEventListener('change', async function () {
  const file = this.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  // æ·»åŠ æ ‡è¯†å‘Šè¯‰åç«¯è¿™æ˜¯ç›®æ ‡æ–‡ä»¶
  const res = await fetch("{{ url_for('asset.upload_file') }}?type=target", {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  if (data.status === "success") {
    document.getElementById("targetInput").value = data.targets.join("\n");
  } else {
    alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼š" + data.message);
  }
});



// å­åŸŸåå­—å…¸ä¸Šä¼ 
document.getElementById('dictFileInput').addEventListener('change', async function () {
  const file = this.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("{{ url_for('asset.upload_file') }}", {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  if (data.status === "success") {
    alert("å­åŸŸåå­—å…¸ä¸Šä¼ æˆåŠŸï¼Œåç»­å°†ä¼˜å…ˆä½¿ç”¨");
  } else {
    alert("å­—å…¸ä¸Šä¼ å¤±è´¥ï¼š" + data.message);
  }
});


document.getElementById('fileInput').addEventListener('change', async function () {
  const file = this.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("file", file);

  const res = await fetch("{{ url_for('asset.upload_file') }}", {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  if (data.status === "success") {
    document.getElementById("targetInput").value = data.targets.join("\n");
  } else {
    alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼š" + data.message);
  }
});

async function startCollection() {
  const raw = document.getElementById("targetInput").value.trim();
  const targets = raw.split(/[\n,ï¼Œ]+/).map(t => t.trim()).filter(Boolean);
  if (targets.length === 0) {
    alert("è¯·ä¸Šä¼ æ–‡ä»¶æˆ–å¡«å†™ç›®æ ‡åå†å¼€å§‹æ”¶é›†");
    return;
  }

  const response = await fetch("{{ url_for('asset.collect') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ targets })
  });

  const data = await response.json();
  if (data.status !== "pending") {
    alert("ä»»åŠ¡å¯åŠ¨å¤±è´¥ï¼š" + data.message);
    return;
  }

  pollProgress(data.task_id);
}

async function pollProgress(taskId) {
  const resultDiv = document.getElementById("result");
  const bar = document.getElementById("progressInner");
  resultDiv.innerHTML = "<p>ğŸ”„ æ­£åœ¨æ”¶é›†èµ„äº§ï¼Œè¯·ç¨å€™...</p>";
  bar.style.width = "0%";

  const interval = setInterval(async () => {
    const res = await fetch(`/asset/progress/${taskId}`);
    const data = await res.json();

    if (data.status === "working") {
      const percent = Math.round(data.current / data.total * 100);
      bar.style.width = percent + "%";
    } else if (data.status === "done") {
      clearInterval(interval);
      bar.style.width = "100%";

      const assets = data.assets;
      window.latestAssets = assets;
      
      const html = assets.map(r => {
        const subdomainList = r.subdomains?.length
          ? '<ul style="margin: 5px 0 0 20px;">' +
              r.subdomains.map(s => `<li>${s.subdomain} (${s.ip})</li>`).join('') +
            '</ul>'
          : 'æ— ';

        return `
          <div class="result-box">
            <strong>åŸŸåï¼š</strong>${r.domain}<br>
            <strong>IPï¼š</strong>${r.ip || 'æ— æ³•è§£æ'}<br>
            <strong>WHOISï¼š</strong>${r.whois?.org || 'æœªçŸ¥'} / ${r.whois?.email || 'æ— '} / ${r.whois?.creation_date || 'æ— '}<br>
            <strong>IPä¿¡æ¯ï¼š</strong>${r.ip_info?.org || 'æ— '} (${r.ip_info?.country || 'æ— '}) ASN: ${r.ip_info?.asn || 'æ— '}<br>
            <strong>å¼€æ”¾ç«¯å£ï¼š</strong>
            <div class="port-table">${formatPortsAsTable(r.ports)}</div>
            <strong>å­åŸŸåï¼š</strong>
            ${subdomainList}
          </div>
        `;
      }).join("");

      resultDiv.innerHTML = html;
      renderCSVTable(assets);
    } else {
      clearInterval(interval);
      alert("ä»»åŠ¡å¤±è´¥ï¼š" + data.message);
    }
  }, 1000);
}

function formatPortsAsTable(rawText) {
  if (!rawText || !rawText.includes("PORT")) {
    return `<pre>${rawText || "æ— æ•°æ®"}</pre>`;
  }

  const lines = rawText.split("\n").filter(line => line.trim());
  const headerIndex = lines.findIndex(line => line.includes("PORT"));
  if (headerIndex === -1) return `<pre>${rawText}</pre>`;

  const dataLines = lines.slice(headerIndex + 1);
  const rows = dataLines.map(line => {
    const parts = line.trim().split(/\s+/);
    if (parts.length < 3) return "";
    const [port, state, ...serviceParts] = parts;
    const service = serviceParts.join(" ");
    const stateClass = state === "open" ? "port-open" : "port-closed";
    return `<tr><td>${port}</td><td class="${stateClass}">${state}</td><td>${service}</td></tr>`;
  }).join("");

  return `
    <table>
      <thead><tr><th>ç«¯å£</th><th>çŠ¶æ€</th><th>æœåŠ¡</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

function renderCSVTable(assets) {
  if (!assets.length) return;
  const headers = ["åŸŸå", "IP", "WHOIS-ç»„ç»‡", "WHOIS-é‚®ç®±", "WHOIS-æ³¨å†Œæ—¶é—´", "ASN", "ç»„ç»‡", "å›½å®¶", "å¼€æ”¾ç«¯å£"];
  let html = `<table class="csv-table"><thead><tr>${headers.map(h => `<th>${h}</th>`).join("")}</tr></thead><tbody>`;
  for (let r of assets) {
    const baseCols = [
      r.domain || "",
      r.ip || "",
      r.whois?.org || "",
      r.whois?.email || "",
      r.whois?.creation_date || "",
      r.ip_info?.asn || "",
      r.ip_info?.org || "",
      r.ip_info?.country || "",
      (r.ports || "").replace(/\n/g, ' ')
    ];

    // å†™ä¸»åŸŸåè¡Œ
    html += `<tr>${baseCols.map(c => `<td>${c}</td>`).join("")}</tr>`;

    // å­åŸŸåæ‰©å±•è¡Œï¼ˆä»…æ˜¾ç¤ºå­åŸŸå + IPï¼‰
    if (r.subdomains && r.subdomains.length) {
      for (const s of r.subdomains) {
        const subCols = [
          `â†³ ${s.subdomain}`,  // ç”¨ç®­å¤´æ ‡è®°æ˜¯å­åŸŸå
          s.ip || "",
          "", "", "", "", "", "", "", ""  // ç•™ç©ºå…¶ä»–åˆ—
        ];
        html += `<tr>${subCols.map(c => `<td>${c}</td>`).join("")}</tr>`;
      }
    }
  }
  html += "</tbody></table>";
  document.getElementById("csvTableContainer").innerHTML = html;
}

async function downloadCSV(onlyIP) {
  const response = await fetch("{{ url_for('asset.download_csv') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      assets: window.latestAssets || [],
      only_ip: onlyIP
    })
  });

  if (!response.ok) {
    alert("ä¸‹è½½å¤±è´¥");
    return;
  }

  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = onlyIP ? "ips_only.csv" : "full_asset_results.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  window.URL.revokeObjectURL(url);
}

</script>
</body>
</html>
