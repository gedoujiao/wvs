<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å…¨çƒçƒ­åŠ›å›¾ - Webæ¼æ´æ‰«æç³»ç»Ÿ</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  <style>
    body {
      background-color: #f4f6f8;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    .scanner-panel {
      padding: 30px;
      margin: 30px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .scanner-panel h2 {
      font-size: 22px;
      margin-bottom: 20px;
      border-left: 5px solid #00bcd4;
      padding-left: 10px;
    }
    .form-section {
      margin-bottom: 20px;
    }
    .form-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    .data-source-info {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .data-source-info h3 {
      margin: 0 0 8px 0;
      color: #00bcd4;
      font-size: 16px;
    }
    .data-source-info p {
      margin: 0;
      color: #666;
      font-size: 14px;
    }
    button {
      background-color: #00bcd4;
      color: white;
      padding: 10px 20px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #00acc1;
    }
    .map-container {
      background-color: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      height: 600px;
      margin-top: 20px;
    }
    .loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #fafafa;
      z-index: 1000;
    }
    .loading-content {
      text-align: center;
      color: #666;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #00bcd4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .map-content {
      width: 100%;
      height: 100%;
    }
    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .alert-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .alert-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .alert-warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }
    .alert-info {
      background-color: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    .hidden {
      display: none !important;
    }
    .controls-section {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .file-upload-hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .result-box {
      background-color: #fafafa;
      border: 1px solid #eee;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
<div class="dashboard-container">
  <header class="topbar">
    <div class="system-title">Webæ¼æ´æ‰«æç³»ç»Ÿ</div>
    <div class="user-box">
      <div class="avatar-container">
        <img src="{{ url_for('static', filename='avatars/' + (avatar or 'avatar.png')) }}" alt="å¤´åƒ" class="avatar">
        <div class="user-tooltip">
          <p>ç”¨æˆ·å: {{ username }}</p>
          <p>ç™»å½•æ¬¡æ•°: {{ login_count }}</p>
          <p>æœ€è¿‘ç™»å½•: {{ last_login }}</p>
          <p>æƒé™ç­‰çº§: {{ 'ç®¡ç†å‘˜' if role == 'admin' else 'æ™®é€šç”¨æˆ·' }}</p>
        </div>
      </div>
      <span class="username">{{ username }}</span>
      <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <div class="body-wrapper">
    <aside class="sidebar">
      <nav class="nav-menu">
        <a href="{{ url_for('index') }}" class="nav-item">ğŸ  é¦–é¡µ</a>
        <a href="{{ url_for('asset.asset_page') }}" class="nav-item">ğŸ’¼ èµ„äº§æ”¶é›†</a>
        <a href="{{ url_for('scanner.scanner_home') }}" class="nav-item">ğŸ” æ¼æ´æ‰«æ</a>
        <a href="{{ url_for('visualization.index') }}" class="nav-item active">ğŸŒ å…¨çƒçƒ­åŠ›å›¾</a>
        <a href="#" class="nav-item">ğŸ“„ æŠ¥å‘Šç”Ÿæˆ</a>
        <a href="#" class="nav-item">ğŸ“Š æ•°æ®åˆ†æ</a>
        <a href="{{ url_for('user.manage_users') }}" class="nav-item">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
      </nav>
    </aside>

    <main class="main-panel">
      <div class="scanner-panel">
        <h2>ğŸŒ å…¨çƒæ¼æ´çƒ­åŠ›å›¾</h2>

        <!-- æ•°æ®æºä¿¡æ¯ -->
        <div class="data-source-info" id="dataSourceInfo">
          <h3 id="dataSourceTitle">ğŸ“Š å½“å‰æ•°æ®æº</h3>
          <p id="dataSourceDesc">æ­£åœ¨æ£€æµ‹æ•°æ®æº...</p>
        </div>

        <!-- æ§åˆ¶åŒºåŸŸ -->
        <div class="form-section">
          <label>æ•°æ®ç®¡ç†</label>
          <div class="controls-section">
            <button onclick="window.location.href='{{ url_for('visualization.upload_csv') }}'">ğŸ“¤ ä¸Šä¼ CSVæ–‡ä»¶</button>
            <button onclick="refreshMap()">ğŸ”„ åˆ·æ–°åœ°å›¾</button>
            <button onclick="showMapInfo()">ğŸ“Š åœ°å›¾ä¿¡æ¯</button>
          </div>
          <div class="file-upload-hint">
            æ”¯æŒæ ¼å¼ï¼šip,çœä»½,æ¼æ´ä¸ªæ•°,é«˜å±ä¸ªæ•°,ä¸­å±ä¸ªæ•°,ä½å±ä¸ªæ•°
          </div>
        </div>

        <!-- çŠ¶æ€æç¤ºåŒºåŸŸ -->
        <div id="alertContainer"></div>

        <!-- åœ°å›¾å®¹å™¨ -->
        <div class="map-container">
          <div class="loading" id="loading">
            <div class="loading-content">
              <div class="spinner"></div>
              <div>ğŸ—ºï¸ æ­£åœ¨åŠ è½½çƒ­åŠ›å›¾æ•°æ®...</div>
            </div>
          </div>
          <div class="map-content" id="mapContent"></div>
        </div>

        <!-- åœ°å›¾ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="mapStats" class="result-box" style="display: none;">
          <strong>ğŸ“ˆ æ•°æ®ç»Ÿè®¡</strong>
          <div id="statsContent">ç‚¹å‡»"åœ°å›¾ä¿¡æ¯"æŒ‰é’®æŸ¥çœ‹è¯¦ç»†ç»Ÿè®¡</div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
// å…¨å±€å˜é‡
let currentFile = null;

function logout() {
  if (confirm("ç¡®è®¤é€€å‡ºç™»å½•ï¼Ÿ")) {
    window.location.href = "{{ url_for('user.logout') }}";
  }
}

// è·å–URLå‚æ•°
function getUrlParameter(name) {
  const urlParams = new URLSearchParams(window.location.search);
  return urlParams.get(name);
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showAlert(message, type = 'info') {
  const alertContainer = document.getElementById('alertContainer');
  const alertDiv = document.createElement('div');

  let icon = 'ğŸ“„';
  let className = 'alert-info';

  switch(type) {
    case 'success':
      icon = 'âœ…';
      className = 'alert-success';
      break;
    case 'error':
      icon = 'âŒ';
      className = 'alert-error';
      break;
    case 'warning':
      icon = 'âš ï¸';
      className = 'alert-warning';
      break;
  }

  alertDiv.className = `alert ${className}`;
  alertDiv.innerHTML = `<span>${icon}</span><span>${message}</span>`;

  // æ¸…é™¤ä¹‹å‰çš„æç¤º
  alertContainer.innerHTML = '';
  alertContainer.appendChild(alertDiv);

  // æˆåŠŸå’Œè­¦å‘Šæ¶ˆæ¯3ç§’åè‡ªåŠ¨æ¶ˆå¤±
  if (type === 'success' || type === 'warning') {
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 3000);
  }
}

// æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
function showLoading(show = true) {
  const loading = document.getElementById('loading');
  loading.classList.toggle('hidden', !show);
}

// æ›´æ–°æ•°æ®æºä¿¡æ¯
function updateDataSourceInfo() {
  const titleElement = document.getElementById('dataSourceTitle');
  const descElement = document.getElementById('dataSourceDesc');

  if (currentFile) {
    titleElement.textContent = 'ğŸ“‚ ä¸Šä¼ æ–‡ä»¶æ•°æ®';
    descElement.innerHTML = `
      <strong>æ–‡ä»¶åï¼š</strong>${currentFile}<br>
      <strong>çŠ¶æ€ï¼š</strong>å·²åŠ è½½è‡ªå®šä¹‰æ¼æ´æ•°æ®<br>
      <strong>è¯´æ˜ï¼š</strong>å½“å‰çƒ­åŠ›å›¾æ˜¾ç¤ºæ‚¨ä¸Šä¼ çš„CSVæ–‡ä»¶ä¸­çš„æ¼æ´åˆ†å¸ƒæ•°æ®
    `;
    showAlert(`æ­£åœ¨ä½¿ç”¨ä¸Šä¼ æ–‡ä»¶: ${currentFile}`, 'success');
  } else {
    titleElement.textContent = 'ğŸ“ æ¼”ç¤ºæ•°æ®';
    descElement.innerHTML = `
      <strong>æ•°æ®æ¥æºï¼š</strong>ç³»ç»Ÿå†…ç½®æ¼”ç¤ºæ•°æ®<br>
      <strong>è¦†ç›–èŒƒå›´ï¼š</strong>å…¨çƒä¸»è¦åŸå¸‚å’Œåœ°åŒº<br>
      <strong>è¯´æ˜ï¼š</strong>åŒ…å«æ¨¡æ‹Ÿçš„æ¼æ´åˆ†å¸ƒæ•°æ®ï¼Œç”¨äºåŠŸèƒ½æ¼”ç¤º
    `;
  }
}

// åŠ è½½çƒ­åŠ›å›¾
async function loadHeatmap() {
  showLoading(true);

  try {
    // æ„å»ºAPI URL
    let apiUrl = '/visualization/api/heatmap';
    if (currentFile) {
      apiUrl += `?file=${encodeURIComponent(currentFile)}`;
    }

    console.log('ğŸ—ºï¸ åŠ è½½çƒ­åŠ›å›¾ API:', apiUrl);

    const response = await fetch(apiUrl);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const htmlContent = await response.text();

    // æ˜¾ç¤ºåœ°å›¾å†…å®¹
    const mapContent = document.getElementById('mapContent');
    mapContent.innerHTML = htmlContent;

    showLoading(false);

    if (currentFile) {
      showAlert('ğŸ¯ çƒ­åŠ›å›¾åŠ è½½æˆåŠŸï¼æ˜¾ç¤ºä¸Šä¼ æ–‡ä»¶æ•°æ®', 'success');
    } else {
      showAlert('ğŸ¯ çƒ­åŠ›å›¾åŠ è½½æˆåŠŸï¼æ˜¾ç¤ºæ¼”ç¤ºæ•°æ®', 'success');
    }

    // éšè—ç»Ÿè®¡ä¿¡æ¯é¢æ¿
    document.getElementById('mapStats').style.display = 'none';

  } catch (error) {
    console.error('âŒ çƒ­åŠ›å›¾åŠ è½½å¤±è´¥:', error);
    showLoading(false);

    const mapContent = document.getElementById('mapContent');
    mapContent.innerHTML = `
      <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 40px; text-align: center; color: #666;">
        <div style="font-size: 4em; margin-bottom: 20px;">ğŸ—ºï¸</div>
        <h3 style="margin-bottom: 15px; color: #f44336;">åœ°å›¾åŠ è½½å¤±è´¥</h3>
        <p style="margin-bottom: 20px; color: #666;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
        <button onclick="loadHeatmap()" style="background-color: #00bcd4; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">ğŸ”„ é‡æ–°åŠ è½½</button>
      </div>
    `;

    showAlert(`åœ°å›¾åŠ è½½å¤±è´¥: ${error.message}`, 'error');
  }
}

// åˆ·æ–°åœ°å›¾
function refreshMap() {
  console.log('ğŸ”„ æ‰‹åŠ¨åˆ·æ–°åœ°å›¾');
  showAlert('æ­£åœ¨åˆ·æ–°åœ°å›¾æ•°æ®...', 'info');
  loadHeatmap();
}

// æ˜¾ç¤ºåœ°å›¾ä¿¡æ¯
async function showMapInfo() {
  const statsDiv = document.getElementById('mapStats');
  const statsContent = document.getElementById('statsContent');

  try {
    showAlert('æ­£åœ¨è·å–åœ°å›¾ç»Ÿè®¡ä¿¡æ¯...', 'info');

    // æ„å»ºç»Ÿè®¡API URL
    let apiUrl = '/visualization/api/stats';
    if (currentFile) {
      apiUrl += `?file=${encodeURIComponent(currentFile)}`;
    }

    const response = await fetch(apiUrl);

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    // æ ¼å¼åŒ–ç»Ÿè®¡ä¿¡æ¯
    const statsHtml = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #00bcd4;">${data.total_locations}</div>
          <div style="color: #666; font-size: 14px;">ç›‘æ§åœ°åŒº</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #007acc;">${data.total_vulns}</div>
          <div style="color: #666; font-size: 14px;">æ¼æ´æ€»æ•°</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #ff5722;">${data.total_high}</div>
          <div style="color: #666; font-size: 14px;">é«˜å±æ¼æ´</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #ff9800;">${data.total_medium}</div>
          <div style="color: #666; font-size: 14px;">ä¸­å±æ¼æ´</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
          <div style="font-size: 24px; font-weight: bold; color: #4caf50;">${data.total_low}</div>
          <div style="color: #666; font-size: 14px;">ä½å±æ¼æ´</div>
        </div>
      </div>

      ${data.top_locations && data.top_locations.length > 0 ? `
      <div style="margin-top: 20px;">
        <h4 style="margin-bottom: 10px; color: #00bcd4;">ğŸ† æ¼æ´æ•°é‡å‰5åœ°åŒº</h4>
        <div style="display: grid; gap: 8px;">
          ${data.top_locations.slice(0, 5).map((loc, index) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f8f9fa; border-radius: 6px;">
              <span style="font-weight: 500;">${index + 1}. ${loc['çœä»½/å·å']}</span>
              <span style="color: #666;">æ€»è®¡: <strong>${loc['æ¼æ´ä¸ªæ•°']}</strong> | é«˜å±: <strong style="color: #ff5722;">${loc['é«˜å±ä¸ªæ•°']}</strong></span>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}
    `;

    statsContent.innerHTML = statsHtml;
    statsDiv.style.display = 'block';

    showAlert('ğŸ“Š ç»Ÿè®¡ä¿¡æ¯åŠ è½½å®Œæˆ', 'success');

  } catch (error) {
    console.error('âŒ è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
    statsContent.innerHTML = `<p style="color: #f44336;">è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${error.message}</p>`;
    statsDiv.style.display = 'block';
    showAlert(`è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
  }
}

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

  // æ£€æŸ¥URLå‚æ•°ä¸­çš„æ–‡ä»¶å
  currentFile = getUrlParameter('file');
  console.log('ğŸ” æ£€æµ‹åˆ°æ–‡ä»¶å‚æ•°:', currentFile);

  // æ›´æ–°æ•°æ®æºä¿¡æ¯
  updateDataSourceInfo();

  // åŠ è½½çƒ­åŠ›å›¾
  loadHeatmap();
});
</script>
</body>
</html>